<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoiseSense: Today vs Yesterday</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #fafafa; color: #333; }
        canvas { border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: block; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; }
        .stats { max-width: 600px; margin: 20px auto; display: flex; justify-content: space-around; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>

    <div class="header">
        <h2 id="sensor-title">Sensor 94448 Noise Levels</h2>
        <p>Comparison: Today vs. Yesterday (Local Time)</p>
    </div>

    <script>
        let sensorHistory = []; 
        let sensorID = "94448";
        let baseUrl = "https://data.sensor.community/airrohr/v1/sensor/" + sensorID + "/";
        let proxy = "https://corsproxy.io/?";
        let fetchTime = 120000; // 2 minutes
        let yMax = 100;
        let latestMax = 0, latestMin = 0, latestEq = 0;

        function setup() {
            let canvas = createCanvas(windowWidth - 40, 400);
            canvas.parent(document.body);

            // 1. Load History from your GitHub Repo
            loadJSON("./data/sensor_history.json", (savedData) => {
                console.log("History loaded.");
                for (let entry of savedData) {
                    let mockEntry = {
                        timestamp: entry.timestamp,
                        sensordatavalues: Object.entries(entry.values).map(([k, v]) => ({value_type: k, value: v}))
                    };
                    processEntry(mockEntry);
                }
                startLivePolling();
            }, (err) => {
                console.warn("History file not found. Starting live mode.");
                startLivePolling();
            });
        }

        function startLivePolling() {
            fetchNewest();
            setInterval(fetchNewest, fetchTime);
        }

        function processEntry(entry) {
            let mx = 0, eq = 0, mn = 0;
            if (!entry.sensordatavalues) return;

            for (let item of entry.sensordatavalues) {
                if (item.value_type === "noise_LA_max") mx = float(item.value);
                if (item.value_type === "noise_LAeq") eq = float(item.value);
                if (item.value_type === "noise_LA_min") mn = float(item.value);
            } 
            
            // Note: We keep entry.timestamp exactly as it comes (UTC) 
            // and handle Local conversion in the draw/mapping functions.
            latestMax = mx; latestEq = eq; latestMin = mn;

            let isNew = sensorHistory.length === 0 || entry.timestamp !== sensorHistory[sensorHistory.length - 1].fullTime;
            
            if (isNew) {
                sensorHistory.push({ mx, eq, mn, fullTime: entry.timestamp });
            }
            // Keep roughly 48 hours of data (288 points per day * 2)
            if (sensorHistory.length > 600) sensorHistory.shift();
        }

        function fetchNewest() {
            let cacheBuster = "?cb=" + new Date().getTime();
            let url = proxy + encodeURIComponent(baseUrl + cacheBuster);
            loadJSON(url, (response) => {
                if (response && response.length > 0) processEntry(response[0]);
            });
        }

        function getStaticX(timestamp) {
            let d = new Date(timestamp + "Z");
            let totalMins = d.getHours() * 60 + d.getMinutes();
            return map(totalMins, 0, 1440, 60, width - 40);
        }

        function draw() {
            background(255);
            drawFixedGrid();

            if (sensorHistory.length < 1) {
                textAlign(CENTER); text("Loading sensor data...", width / 2, height / 2);
                return;
            }

            let now = new Date();
            let todayStr = now.toLocaleDateString();
            let yesterday = new Date();
            yesterday.setDate(now.getDate() - 1);
            let yesterdayStr = yesterday.toLocaleDateString();

            // 1. DRAW YESTERDAY'S SHADOW
            noFill();
            stroke(200, 200, 200, 180); 
            strokeWeight(1.5);
            beginShape();
            for (let p of sensorHistory) {
                let d = new Date(p.fullTime + "Z");
                if (d.toLocaleDateString() === yesterdayStr) {
                    vertex(getStaticX(p.fullTime), map(p.eq, 0, yMax, height - 70, 50));
                }
            }
            endShape();

            // 2. DRAW TODAY'S RANGE (MIN/MAX)
            noStroke();
            fill(100, 150, 255, 40);
            beginShape();
            for (let p of sensorHistory) {
                let d = new Date(p.fullTime + "Z");
                if (d.toLocaleDateString() === todayStr) {
                    vertex(getStaticX(p.fullTime), map(p.mx, 0, yMax, height - 70, 50));
                }
            }
            for (let i = sensorHistory.length - 1; i >= 0; i--) {
                let p = sensorHistory[i];
                let d = new Date(p.fullTime + "Z");
                if (d.toLocaleDateString() === todayStr) {
                    vertex(getStaticX(p.fullTime), map(p.mn, 0, yMax, height - 70, 50));
                }
            }
            endShape(CLOSE);

            // 3. DRAW TODAY'S AVERAGE (EQUIVALENT) LINE
            noFill(); stroke(0); strokeWeight(2);
            beginShape();
            for (let p of sensorHistory) {
                let d = new Date(p.fullTime + "Z");
                if (d.toLocaleDateString() === todayStr) {
                    vertex(getStaticX(p.fullTime), map(p.eq, 0, yMax, height - 70, 50));
                }
            }
            endShape();

            // 4. DRAW CURRENT TIME & LEGEND
            drawNowMarker();
            drawLegend();
        }

        function drawFixedGrid() {
            for (let h = 0; h <= 24; h++) {
                let x = map(h * 60, 0, 1440, 60, width - 40);
                stroke(245); line(x, 50, x, height - 70);
                if (h % 3 === 0) {
                    noStroke(); fill(180); textAlign(CENTER); textSize(10);
                    text(h + ":00", x, height - 50);
                }
            }
            for (let d = 0; d <= yMax; d += 20) {
                let y = map(d, 0, yMax, height - 70, 50);
                stroke(250); line(60, y, width - 40, y);
                noStroke(); fill(180); textAlign(RIGHT); text(d, 50, y + 4);
            }
        }

        function drawNowMarker() {
            let n = new Date();
            let nowX = getStaticX(n.toISOString());
            stroke(255, 0, 0, 150); line(nowX, 50, nowX, height - 70);
            fill(255, 0, 0); noStroke(); textAlign(CENTER); textSize(10);
            text("NOW", nowX, 45);
        }

        function drawLegend() {
            textAlign(RIGHT); textSize(11);
            fill(180); text("——— Yesterday", width - 40, 20);
            fill(0);   text("——— Today (Avg)", width - 40, 35);
            fill(100, 150, 255); text("■ Today Range (Min/Max)", width - 40, 50);
        }

        function windowResized() {
            resizeCanvas(windowWidth - 40, 400);
        }
    </script>
</body>
</html>
